---
title: "Modeling proportions"
output: 
  html_notebook: deafult
---

Summary:
0. In all SES variables including race, education, federal poverty level, home ownership, occupation, income, networth, and division, all NA values are coded as the same as the missing level ("0" or "U").

1. Federal poverty level only has 3 levels "Above 400% FPL", "Below 400% FPL", and "Unkown", and very few people (<=3) have "Below 400% FPL". Thus fed_poverty is not used.

2. Home ownership only has "probable homeowner" and "unknown". This does not provide useful information so is not used.

3. Occupation has >75\% "unknown" and is thus not used.

4. For race, "Asian" and "Hispanic" are combined.

5. In index VTE types, the 3 smallest levels IVC, PV, RV, are combined.

6. In comorbidity, 2 additional covariates are created. comorb_01 = I\{have at least one comorbidity\}, and n_comorb = \#\{comorbidities\}.

7. In education, "Less than 12th Grade" ("A") and "High School Diploma" ("B") is merged into "AB".

8. In antiplatelets, antiplatelet = I\{ have at least one antiplatelet\}.

Covariates within consideration:
age (scaled), male, index_vte_type (combined), comorbidities (individuals, comorb_01, or n_comorb), education (raw, or combined), income_range, networth_range, race (raw, or combined), division (raw, or combined), product, surgery, smoke, hospitalized, vte_history, antiplatelet 

What to do with index cancer type, and lab tests? Index cancer type has many levels, and lab tests have small counts.


* To compare proportions of LMWH at index AC and AC3Mo,
1. Models have large intercept (~-8)

2. Without the two smallest education levels, MCMCglmm gives decent estimates. But how to validate the result and how to choose an appropriate prior?


* To compare proportions of Warfarin at index AC and AC3Mo,

1. Whenever education is included in the model, the model will not converge, no matter whether the two education levels with the smallest counts are removed.

2. Model does not converge in Rstudio but converges in command line. 
Model 3: warfarin ~ VTE_Lower.extremity.DVT + VTE_Other + VTE_Pulmonary.embolism + 
    VTE_Upper.extremity.DVT + n_comorb + time + race + male + 
    age_s + product + income_range + occupation + (1 | patid)



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = 'C:/Users/mengbing/Box Sync/OptumInsight_DataManagement/analysis/a1_proportions')

library(dplyr)
library(tidyr)  
library(data.table)
library(knitr)
library(kableExtra)
library(reshape2)
library(xlsx)
library(readxl)
library(lme4)
library(gee)
library(geepack)
library(nlme)
library(MCMCglmm)
```


```{r}
dat <- data.table(readRDS("../../data/prog100_analysis_data.rds"))

# UNKNOWN VALUE IN THESE VARIABLES ARE CODED AS "U"
ses1 <- c("education", "fed_poverty",  "occupation")
dat2 <- dat[, (ses1) := lapply(.SD, function(x) ifelse(is.na(x), "U", x)), .SDcols=ses1]

# UNKNOWN VALUE IN THESE VARIABLES ARE CODED AS "0"
ses2 <- c("home_ownership", "networth_range", "income_range")
dat2[, (ses2) := lapply(.SD, function(x) ifelse(is.na(x), "0", x)), .SDcols=ses2]

dat2 <- dat2[, c("index_ac_lmwh","ac3mo_lmwh", "index_ac_warfarin","ac3mo_warfarin") := .(index_ac=="LMWH", outcome=="LMWH", index_ac=="Warfarin", outcome=="Warfarin")]

# unwrap combined index VTE types into columns of binary indicators
vte_info <- read_excel("../../data/prog8_vte.xlsx", sheet = "raw_VTE_POS")
vte_info2 <- unique(data.table(vte_info)[!is.na(VTE_type),.(patid, VTE_type)])
vte <- model.matrix(patid~VTE_type+0, data=vte_info2)
colnames(vte) <- gsub("type", "", colnames(vte))
vte2 <- data.frame(cbind(vte_info2[,1], vte))
vte3 <- aggregate(. ~ patid, vte2, sum)
dat2 <- merge(x=dat2, y=vte3, by="patid", all.x = TRUE)
rm(vte_info, vte_info2, vte, vte2, vte3)

# combine the 3 rarest VTE types
dat2[,VTE_ivc_rv_pv:= as.numeric((VTE_IVC | VTE_Portal.vein | VTE_Renal.vein))]

comorb_names <- colnames(dat2)[grep("comorbidity", colnames(dat2))]
dat2[, (comorb_names) := lapply(.SD, function(x) ifelse(is.na(x), 0, x)), .SDcols = comorb_names]
dat2[,comorb01 := !is.na(comorbidities)]
# count the number of comorbidities
dat2[, ("n_comorb") := rowSums(.SD), .SDcols=comorb_names]
summary(dat2$n_comorb)

dat2[, race := ifelse(race=="", "U", race)]

antip_names <- colnames(dat2)[grep("antiplatelet", colnames(dat2))]
dat2[, (antip_names) := lapply(.SD, function(x) ifelse(is.na(x), 0, x)), .SDcols = antip_names]
dat2[, ("antiplatelet") := (rowSums(.SD) > 0), .SDcols=antip_names]

dat2[,c("race", "division", "product", "education", "fed_poverty","income_range", "networth_range", "occupation")] <- lapply(dat2[,c("race", "division", "product", "education", "fed_poverty","income_range", "networth_range", "occupation")], as.factor)

# pdf("a1_hist_n_comorbidities.pdf")
hist(dat2$n_comorb, main="Histogram of number of comorbidities",
     xlab="Number of comorbidities")
# dev.off()

# scaled age
dat2$age_s <- scale(dat2$age)
# center age by mean
dat2$age_c <- dat2$age - mean(dat2$age)

# combine the smallest education level to the next level
dat2[,education2 := as.factor(ifelse(as.character(education) %in% c("B", "A"), "AB", as.character(education)))]

# use the largest level as the reference level
dat2 <- within(dat2, education <- relevel(education, ref = "C"))
dat2 <- within(dat2, education2 <- relevel(education2, ref = "C"))
dat2 <- within(dat2, race <- relevel(race, ref = "W"))
dat2 <- within(dat2, income_range <- relevel(income_range, ref = "6"))

# combine asian and hispanic for race
dat2[,race2 := as.factor(ifelse(as.character(race) %in% c("H", "A"), "AsianHispanic", as.character(race)))]

# combine regions for division
dat2 <- data.table(dat2 %>%
  mutate(division2 = case_when(
    division %in% c("WEST SOUTH CENTRAL", "WEST NORTH CENTRAL") ~ "WEST CENTRAL",
    division %in% c("EAST SOUTH CENTRAL", "EAST NORTH CENTRAL") ~ "EAST CENTRAL",
    division %in% c("SOUTH ATLANTIC", "MIDDLE ATLANTIC", "NEW ENGLAND") ~ "ATLANTIC_ENGLAND",
    division %in% c("MOUNTAIN", "PACIFIC") ~ "MOUNTAIN_PACIFIC",
    TRUE ~ "UNKNOWN"
  )))

# combine insurace type
dat2[,product2 := as.factor(ifelse(as.character(product) %in% c("EPO", "IND", "PPO"), "EPO_IND_PPO", as.character(product)))]

# obtain variable names for index VTE types
# all distinct VTE categories
vte_names0 <- colnames(dat2)[grep("VTE_", colnames(dat2))]
vte_names1 <- vte_names0[-which(vte_names0 %in% c("VTE_IVC","VTE_Portal.vein", "VTE_Renal.vein"))]
# "VTE_ivc_rv_pv" as the reference level
vte_names_noref <- vte_names1[-which(vte_names1 == "VTE_ivc_rv_pv")]
```


# Compare proportions of LMWH at indexAC versus AC3Mo
```{r}
dat3 <- melt(dat2, measure.vars = c("index_ac_lmwh", "ac3mo_lmwh"),
             value.name = "LMWH", variable.name = "time")
dat3[, c("clmid", "fill_dt", "category", "brand_name", "gen_name", "copay", "copay_sum", "days_sup", "quantity","strength", "npi", "index_ac_warfarin", "ac3mo_warfarin"):=NULL]
dat4 <- unique(dat3)

dat4[, index_vte_type2 := ifelse(index_vte_type %in% c("IVC", "Portal vein", "Renal vein"), "ivc_rv_rv", index_vte_type)]

sample_id <- sample(unique(dat4$patid),2000, replace = FALSE)
sample_dat <- dat4[dat4$patid %in% sample_id,]

# obtain variable names for index VTE types
# all distinct VTE categories
# vte_names0 <- colnames(sample_dat)[grep("VTE_", colnames(sample_dat))]
# vte_names1 <- vte_names0[-which(vte_names0 %in% c("VTE_IVC","VTE_Portal.vein", "VTE_Renal.vein"))]
# "VTE_ivc_rv_pv" as the reference level
# vte_names_noref <- vte_names1[-which(vte_names1 == "VTE_ivc_rv_pv")]

# example <- sample_dat[sample_dat$patid==factor(sample_dat$patid[1:2]),] %>%  arrange(patid, time)
# kable(example) %>%
  # kable_styling(bootstrap_options = c("striped", "hover"))
```



#### Cell counts of index VTE type by AC
```{r, warning=TRUE}
# fit2 <- glmer(LMWH ~ age_c + index_vte_type + (1|patid),data=sample_dat, family = "binomial")
# summary(fit2)

table(dat4$index_vte_type, dat4$LMWH, dat4$time) # notice that ivc, pv, and rv have small counts

table(dat4$index_vte_type2, dat4$LMWH)

# data_index_lmwh <- dat4[time=="index_ac_lmwh", .SD, .SDcols=c(comorb_names, vte_names1, "LMWH")]
# index_lmwh_ct <- aggregate(.~LMWH, data_index_lmwh, sum)
# kable(index_lmwh_ct) %>%
#   kable_styling(bootstrap_options = c("striped", "hover"))

# data_ac3mo_lmwh <- dat4[time=="ac3mo_lmwh", .SD, .SDcols=c(comorb_names, vte_names1, "LMWH")]
# aggregate(.~LMWH, data_ac3mo_lmwh, sum)
# kable(outcome_lmwh_ct) %>%
#   kable_styling(bootstrap_options = c("striped", "hover"))
```


## glmer --------------------------

### Model 5 using GLMM

No issue with convergence
```{r}
# "VTE_ivc_pv_rv" as reference level for index VTE; "comorbidity.Aids.HIV" as reference level for comorbidities
fm5 <- as.formula(paste("LMWH~", paste(c(vte_names_noref, comorb_names[-1]), collapse="+"), "+ age_s + time + race + male + education + (1|patid)")) #income_range + product + 

system.time(fit5 <- glmer(fm5, data=sample_dat, family = "binomial", control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=1e8))))
summary(fit5)
```


### Model 6 
Does not converge.
```{r}
# "VTE_ivc_pv_rv" as reference level for index VTE; "comorbidity.Aids.HIV" as reference level for comorbidities
fm6 <- as.formula(paste("LMWH~", paste(c(vte_names_noref, comorb_names[-1]), collapse="+"), "+ age_s + time + race + male + education + income_range + (1|patid)")) # product + 

system.time(fit6 <- glmer(fm6, data=sample_dat, family = "binomial", control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=1e8))))
summary(fit6)
```



### Model 7: same covariates as fit7.gee
Model does not converge
```{r}
fm7 <- as.formula(paste("LMWH~", paste(vte_names_noref, collapse="+"), "+ age_s + n_comorb + time + race2 + male + education2 + vte_history + hospitalized + smoke + division2 + income_range + product2 + (1|patid)"))

system.time(fit7 <- glmer(fm7, data=dat4, family = "binomial", control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=1e8))))
summary(fit7)
```
    user   system  elapsed
 8917.93  1323.02 12052.05
Warning message:
In checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,  :
  Model failed to converge with max|grad| = 0.00144537 (tol = 0.001, component 1)
  
Generalized linear mixed model fit by maximum likelihood (Laplace
  Approximation) [glmerMod]
 Family: binomial  ( logit )
Formula: LMWH ~ VTE_Lower.extremity.DVT + VTE_Other + VTE_Pulmonary.embolism +
    VTE_Upper.extremity.DVT + age_s + n_comorb + time + race2 +
    male + education2 + vte_history + hospitalized + smoke +
    division2 + income_range + product2 + (1 | patid)
   Data: dat4
Control: glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e+08))

     AIC      BIC   logLik deviance df.resid
 18726.9  18992.6  -9331.4  18662.9    29858

Scaled residuals:
     Min       1Q   Median       3Q      Max
-2.15168 -0.01208 -0.00331 -0.00179  2.50483

Random effects:
 Groups Name        Variance Std.Dev.
 patid  (Intercept) 236.9    15.39
Number of obs: 29890, groups:  patid, 14945

Fixed effects:
                          Estimate Std. Error z value Pr(>|z|)
(Intercept)               -7.85762    0.42069 -18.678  < 2e-16 ***
VTE_Lower.extremity.DVT   -0.32544    0.18190  -1.789   0.0736 .
VTE_Other                 -0.31542    0.21695  -1.454   0.1460
VTE_Pulmonary.embolism    -0.03910    0.19489  -0.201   0.8410
VTE_Upper.extremity.DVT   -0.04135    0.23495  -0.176   0.8603
age_s                     -0.35242    0.08649  -4.075 4.61e-05 ***
n_comorb                  -0.02679    0.03296  -0.813   0.4163
timeac3mo_lmwh            -3.31369    0.13237 -25.034  < 2e-16 ***
race2B                    -0.16493    0.31857  -0.518   0.6047
race2U                    -0.15712    0.44922  -0.350   0.7265
race2W                    -0.32714    0.26088  -1.254   0.2098
male                       0.04100    0.14175   0.289   0.7724
education2AB              -0.17739    0.17537  -1.012   0.3118
education2D                0.29349    0.20756   1.414   0.1574
education2U               -0.12149    0.60483  -0.201   0.8408
vte_history               -0.30135    0.26873  -1.121   0.2621
hospitalizedTRUE           0.30805    0.18020   1.710   0.0874 .
smokeTRUE                 -0.28982    1.40857  -0.206   0.8370
division2EAST CENTRAL     -0.20482    0.19493  -1.051   0.2934
division2MOUNTAIN_PACIFIC -0.40714    0.21280  -1.913   0.0557 .
division2UNKNOWN          -0.29945    1.22417  -0.245   0.8068
division2WEST CENTRAL     -0.24492    0.19358  -1.265   0.2058
income_range0             -0.17411    0.27458  -0.634   0.5260
income_range1             -0.29347    0.23760  -1.235   0.2168
income_range2             -0.24305    0.30152  -0.806   0.4202
income_range3             -0.26689    0.30420  -0.877   0.3803
income_range4              0.02785    0.25914   0.107   0.9144
income_range5             -0.16132    0.23810  -0.678   0.4981
product2HMO               -0.09311    0.23695  -0.393   0.6944
product2OTH                0.02255    0.24754   0.091   0.9274
product2POS                0.36218    0.21722   1.667   0.0954 .
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation matrix not shown by default, as p = 31 > 12.
Use print(x, correlation=TRUE)  or
         vcov(x)         if you need it

convergence code: 0
Model failed to converge with max|grad| = 0.00144537 (tol = 0.001, component 1)


### Model 8:
Run on full data:
```{r}
fm8 <- as.formula(paste("LMWH~", paste(vte_names_noref, collapse="+"), " + comorb01 + age_s + time + race + male + education2 + income_range + (1|patid)")) 

system.time(fit8 <- glmer(fm8, data=dat4, family = "binomial", control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=1e8))))
summary(fit8)
```

   user  system elapsed
1025.97  160.89 1428.84

Generalized linear mixed model fit by maximum likelihood (Laplace
  Approximation) [glmerMod]
 Family: binomial  ( logit )
Formula: LMWH ~ VTE_Lower.extremity.DVT + VTE_Other + VTE_Pulmonary.embolism +
    VTE_Upper.extremity.DVT + comorb01 + age_s + time + race +
    male + education2 + income_range + (1 | patid)
   Data: dat4
Control: glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e+08))

     AIC      BIC   logLik deviance df.resid
 18721.6  18912.6  -9337.8  18675.6    29867

Scaled residuals:
     Min       1Q   Median       3Q      Max
-2.15842 -0.01221 -0.00317 -0.00182  2.50831

Random effects:
 Groups Name        Variance Std.Dev.
 patid  (Intercept) 239.4    15.47
Number of obs: 29890, groups:  patid, 14945

Fixed effects:
                        Estimate Std. Error z value Pr(>|z|)
(Intercept)             -8.53712    0.35672 -23.932  < 2e-16 ***
VTE_Lower.extremity.DVT -0.31950    0.18161  -1.759   0.0785 .
VTE_Other               -0.31014    0.21690  -1.430   0.1528
VTE_Pulmonary.embolism  -0.04875    0.19432  -0.251   0.8019
VTE_Upper.extremity.DVT -0.03081    0.23462  -0.131   0.8955
comorb01TRUE             0.23311    0.25467   0.915   0.3600
age_s                   -0.47121    0.07283  -6.470 9.79e-11 ***
timeac3mo_lmwh          -3.32705    0.13274 -25.065  < 2e-16 ***
raceA                    0.70059    0.49606   1.412   0.1579
raceB                    0.17886    0.21691   0.825   0.4096
raceH                    0.14591    0.29712   0.491   0.6234
raceU                    0.18464    0.38267   0.483   0.6294
male                     0.03692    0.14071   0.262   0.7930
education2AB            -0.12439    0.17312  -0.718   0.4725
education2D              0.30553    0.20660   1.479   0.1392
education2U             -0.16928    0.60275  -0.281   0.7788
income_range0           -0.24273    0.27311  -0.889   0.3741
income_range1           -0.36925    0.23438  -1.575   0.1152
income_range2           -0.31217    0.30029  -1.040   0.2985
income_range3           -0.30832    0.30323  -1.017   0.3093
income_range4            0.00880    0.25812   0.034   0.9728
income_range5           -0.18566    0.23731  -0.782   0.4340
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation matrix not shown by default, as p = 22 > 12.
Use print(x, correlation=TRUE)  or
         vcov(x)         if you need it



```{r}
# individual predicted probabilities
pred.ind_fit8 <- predict(fit8,type="response")

pdf("a1_predicted_prob_fit8.pdf")
hist(pred.ind_fit8, breaks=40, xlab="Predicted probability",
     main="LMWH ~ VTE_Lower.extremity.DVT + VTE_Other + \n VTE_Pulmonary.embolism + VTE_Upper.extremity.DVT + \n comorb01 + age_s + n_comorb + time + race + \n male + education2 + income_range + (1 | patid)")
while (!is.null(dev.list()))  dev.off()

summary(pred.ind_fit8)
```
     Min.   1st Qu.    Median      Mean   3rd Qu.      Max.
0.0000014 0.0000069 0.0001138 0.1747420 0.0004659 0.9981103



### Restart with model estimates and see if the estimates are similar:
```{r}
pars <- getME(fit8,c("theta","fixef"))
fit8.restart <- update(fit8, start=pars)
summary(fit8.restart)
```
It gives the same estimates.



### No convergence issue with GLM:
```{r}
fm.glm <- as.formula(paste("LMWH~", paste(vte_names_noref, collapse="+"), "+ n_comorb + age_s + time + race + male + education + income_range + product")) 
glm(fm.glm, data = dat4, family = "binomial")
```






## GEE ------------------------------------

### Model 7 using GEE
```{r}
fm7.gee <- as.formula(paste("LMWH~", paste(c(vte_names_noref, comorb_names[-1]), collapse="+"), "+ age_s + time + race + male + education + vte_history + hospitalized + smoke"))

model7.gee <- geeglm(fm7.gee, family = "binomial", id=patid, data = dat4, corstr="exchangeable")
summary(model7.gee)
```
Call:
geeglm(formula = fm7, family = "binomial", data = dat4, id = patid, 
    corstr = "exchangeable")

 Coefficients:
                                                  Estimate Std.err   Wald
(Intercept)                                        -1.2787  0.0589 471.75
VTE_Lower.extremity.DVT                            -0.2210  0.0405  29.72
VTE_Other                                          -0.2158  0.0484  19.89
VTE_Pulmonary.embolism                             -0.0065  0.0434   0.02
VTE_Upper.extremity.DVT                             0.0241  0.0527   0.21
comorbidity.Alcohol.abuse                           0.0118  0.1057   0.01
comorbidity.Blood.loss.anemia                      -0.1753  0.0955   3.37
comorbidity.Cardiac.arrhythmia                      0.0187  0.0378   0.24
comorbidity.Cerebrovascular.disease                 0.0560  0.0478   1.37
comorbidity.Chronic.pulmonary.disease              -0.1151  0.0353  10.63
comorbidity.Congestive.heart.failure               -0.1519  0.0514   8.75
comorbidity.Deficiency.anemia                      -0.1278  0.0478   7.14
comorbidity.Dementia                               -0.0889  0.1172   0.57
comorbidity.Diabetes.with.chronic.complication     -0.1069  0.0728   2.16
comorbidity.Diabetes.without.chronic.complication   0.0391  0.0415   0.89
comorbidity.Drug.abuse                              0.0195  0.1058   0.03
comorbidity.Hemiplegia.or.paraplegia                0.3951  0.0885  19.94
comorbidity.Hypertension                           -0.0637  0.0370   2.97
comorbidity.Mild.liver.disease                      0.4936  0.0357 190.82
comorbidity.Moderate.or.severe.liver.disease        0.1632  0.1437   1.29
comorbidity.Myocardial.infarction                  -0.0238  0.0648   0.14
comorbidity.Obesity                                -0.2383  0.0462  26.55
comorbidity.Peptic.ulcer.disease                    0.3429  0.0818  17.56
comorbidity.Peripheral.vascular.disease            -0.1753  0.0477  13.52
comorbidity.Renal.disease                          -0.1428  0.0488   8.57
comorbidity.Rheumatic.disease                      -0.0814  0.0733   1.24
comorbidity.Thrombocytopenia                        0.2229  0.0491  20.64
comorbidity.Valvular.disease                       -0.0737  0.0454   2.63
age_s                                              -0.3615  0.0168 463.71
timeac3mo_lmwh                                     -0.4574  0.0314 212.94
raceA                                               0.4737  0.1095  18.73
raceB                                               0.1707  0.0486  12.33
raceH                                               0.1044  0.0683   2.33
raceU                                               0.1213  0.0845   2.06
male                                                0.0203  0.0320   0.40
educationA                                         -0.4027  0.2997   1.81
educationB                                         -0.1486  0.0372  16.00
educationD                                          0.2804  0.0439  40.88
educationU                                         -0.1656  0.1263   1.72
vte_history                                        -0.2804  0.0593  22.34
hospitalizedTRUE                                    0.2097  0.0405  26.81
smokeTRUE                                          -0.2141  0.3116   0.47
                                                  Pr(>|W|)    
(Intercept)                                        < 2e-16 ***
VTE_Lower.extremity.DVT                            5.0e-08 ***
VTE_Other                                          8.2e-06 ***
VTE_Pulmonary.embolism                             0.88109    
VTE_Upper.extremity.DVT                            0.64710    
comorbidity.Alcohol.abuse                          0.91068    
comorbidity.Blood.loss.anemia                      0.06642 .  
comorbidity.Cardiac.arrhythmia                     0.62075    
comorbidity.Cerebrovascular.disease                0.24120    
comorbidity.Chronic.pulmonary.disease              0.00112 ** 
comorbidity.Congestive.heart.failure               0.00310 ** 
comorbidity.Deficiency.anemia                      0.00753 ** 
comorbidity.Dementia                               0.44856    
comorbidity.Diabetes.with.chronic.complication     0.14185    
comorbidity.Diabetes.without.chronic.complication  0.34529    
comorbidity.Drug.abuse                             0.85390    
comorbidity.Hemiplegia.or.paraplegia               8.0e-06 ***
comorbidity.Hypertension                           0.08506 .  
comorbidity.Mild.liver.disease                     < 2e-16 ***
comorbidity.Moderate.or.severe.liver.disease       0.25585    
comorbidity.Myocardial.infarction                  0.71309    
comorbidity.Obesity                                2.6e-07 ***
comorbidity.Peptic.ulcer.disease                   2.8e-05 ***
comorbidity.Peripheral.vascular.disease            0.00024 ***
comorbidity.Renal.disease                          0.00341 ** 
comorbidity.Rheumatic.disease                      0.26627    
comorbidity.Thrombocytopenia                       5.5e-06 ***
comorbidity.Valvular.disease                       0.10490    
age_s                                              < 2e-16 ***
timeac3mo_lmwh                                     < 2e-16 ***
raceA                                              1.5e-05 ***
raceB                                              0.00045 ***
raceH                                              0.12668    
raceU                                              0.15127    
male                                               0.52621    
educationA                                         0.17908    
educationB                                         6.3e-05 ***
educationD                                         1.6e-10 ***
educationU                                         0.18960    
vte_history                                        2.3e-06 ***
hospitalizedTRUE                                   2.2e-07 ***
smokeTRUE                                          0.49213    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Estimated Scale Parameters:
            Estimate Std.err
(Intercept)    0.989  0.0257

Correlation: Structure = exchangeable  Link = identity 

Estimated Correlation Parameters:
      Estimate Std.err
alpha        0       0
Number of clusters:   29890   Maximum cluster size: 1 


### Model 7.2 using GEE
Individual comorbidities are replaced with the number of comorbidities.
```{r}
fm7.2.gee <- as.formula(paste("LMWH~", paste(vte_names_noref, collapse="+"), "+ age_s + n_comorb + time + race + male + education + vte_history + hospitalized + smoke + division + income_range + product + antiplatelet"))

model7.2.gee <- geeglm(fm7.2.gee, family = "binomial", id=patid, data = dat4, corstr="exchangeable")
summary(model7.2.gee)
```
Call:
geeglm(formula = fm7.2.gee, family = "binomial", data = dat4, 
    id = patid, corstr = "exchangeable")

 Coefficients:
                           Estimate  Std.err   Wald Pr(>|W|)    
(Intercept)                -0.95397  0.09659  97.54  < 2e-16 ***
VTE_Lower.extremity.DVT    -0.24805  0.04087  36.84  1.3e-09 ***
VTE_Other                  -0.24591  0.04893  25.26  5.0e-07 ***
VTE_Pulmonary.embolism     -0.02315  0.04372   0.28  0.59651    
VTE_Upper.extremity.DVT     0.00182  0.05299   0.00  0.97262    
age_s                      -0.29234  0.01994 214.96  < 2e-16 ***
n_comorb                   -0.02178  0.00740   8.66  0.00325 ** 
timeac3mo_lmwh             -0.45770  0.03136 213.00  < 2e-16 ***
raceA                       0.47660  0.11127  18.35  1.8e-05 ***
raceB                       0.20456  0.04981  16.86  4.0e-05 ***
raceH                       0.15439  0.06833   5.11  0.02385 *  
raceU                       0.09305  0.08292   1.26  0.26178    
male                        0.03240  0.03168   1.05  0.30654    
educationA                 -0.32711  0.29923   1.20  0.27432    
educationB                 -0.11372  0.03936   8.35  0.00386 ** 
educationD                  0.20325  0.04606  19.47  1.0e-05 ***
educationU                 -0.03291  0.13285   0.06  0.80436    
vte_history                -0.29729  0.05965  24.84  6.2e-07 ***
hospitalizedTRUE            0.22501  0.03999  31.66  1.8e-08 ***
smokeTRUE                  -0.17264  0.31242   0.31  0.58055    
divisionEAST SOUTH CENTRAL -0.66015  0.09801  45.37  1.6e-11 ***
divisionMIDDLE ATLANTIC     0.47042  0.07085  44.08  3.2e-11 ***
divisionMOUNTAIN           -0.45468  0.06572  47.86  4.6e-12 ***
divisionNEW ENGLAND         0.52102  0.07960  42.85  5.9e-11 ***
divisionPACIFIC            -0.05719  0.06600   0.75  0.38620    
divisionSOUTH ATLANTIC     -0.09760  0.04945   3.90  0.04840 *  
divisionUNKNOWN            -0.20005  0.26910   0.55  0.45723    
divisionWEST NORTH CENTRAL -0.07628  0.06187   1.52  0.21756    
divisionWEST SOUTH CENTRAL -0.17615  0.05906   8.90  0.00286 ** 
income_range0              -0.15213  0.06125   6.17  0.01300 *  
income_range1              -0.23985  0.05347  20.12  7.3e-06 ***
income_range2              -0.21455  0.06755  10.09  0.00149 ** 
income_range3              -0.22358  0.06839  10.69  0.00108 ** 
income_range4               0.01355  0.05775   0.06  0.81447    
income_range5              -0.12317  0.05334   5.33  0.02095 *  
productHMO                 -0.25000  0.07573  10.90  0.00096 ***
productIND                 -0.21693  0.11750   3.41  0.06486 .  
productOTH                 -0.15445  0.07893   3.83  0.05039 .  
productPOS                  0.15515  0.06688   5.38  0.02035 *  
productPPO                 -0.27014  0.08878   9.26  0.00235 ** 
antiplateletTRUE            0.01315  0.07993   0.03  0.86933    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Estimated Scale Parameters:
            Estimate Std.err
(Intercept)    0.993  0.0273

Correlation: Structure = exchangeable  Link = identity 

Estimated Correlation Parameters:
      Estimate Std.err
alpha        0       0
Number of clusters:   29890   Maximum cluster size: 1 



### Model 7.3.gee
Use combined categories.
```{r}
fm7.3.gee <- as.formula(paste("LMWH~", paste(vte_names_noref, collapse="+"), "+ age_s + n_comorb + time + race2 + male + education2 + vte_history + hospitalized + smoke + division2 + income_range + product2 + antiplatelet"))

model7.3.gee <- geeglm(fm7.3.gee, family=binomial("logit"), id=patid, data = dat4, corstr="exchangeable")
summary(model7.3.gee)
```
Call:
geeglm(formula = fm7.3.gee, family = binomial("logit"), data = dat4, 
    id = patid, corstr = "exchangeable")

 Coefficients:
                           Estimate   Std.err   Wald Pr(>|W|)    
(Intercept)               -0.727891  0.093578  60.50  7.3e-15 ***
VTE_Lower.extremity.DVT   -0.258935  0.040648  40.58  1.9e-10 ***
VTE_Other                 -0.260389  0.048495  28.83  7.9e-08 ***
VTE_Pulmonary.embolism    -0.030555  0.043474   0.49  0.48216    
VTE_Upper.extremity.DVT   -0.019576  0.052669   0.14  0.71013    
age_s                     -0.295340  0.018966 242.49  < 2e-16 ***
n_comorb                  -0.022926  0.007377   9.66  0.00188 ** 
timeac3mo_lmwh            -0.454093  0.031234 211.37  < 2e-16 ***
race2B                    -0.133808  0.071300   3.52  0.06056 .  
race2U                    -0.159638  0.098795   2.61  0.10613    
race2W                    -0.274799  0.058471  22.09  2.6e-06 ***
male                       0.024173  0.031542   0.59  0.44346    
education2AB              -0.145150  0.038988  13.86  0.00020 ***
education2D                0.215687  0.045770  22.21  2.4e-06 ***
education2U               -0.069601  0.132741   0.27  0.60005    
vte_history               -0.290097  0.059135  24.07  9.3e-07 ***
hospitalizedTRUE           0.227695  0.039773  32.77  1.0e-08 ***
smokeTRUE                 -0.251203  0.309335   0.66  0.41675    
division2EAST CENTRAL     -0.174648  0.043478  16.14  5.9e-05 ***
division2MOUNTAIN_PACIFIC -0.343219  0.047490  52.23  4.9e-13 ***
division2UNKNOWN          -0.271723  0.269389   1.02  0.31314    
division2WEST CENTRAL     -0.196376  0.043492  20.39  6.3e-06 ***
income_range0             -0.154114  0.060897   6.40  0.01138 *  
income_range1             -0.253928  0.053057  22.91  1.7e-06 ***
income_range2             -0.225795  0.067219  11.28  0.00078 ***
income_range3             -0.224658  0.067822  10.97  0.00092 ***
income_range4              0.021436  0.057569   0.14  0.70964    
income_range5             -0.125208  0.053076   5.57  0.01832 *  
product2HMO               -0.106878  0.053333   4.02  0.04507 *  
product2OTH                0.013188  0.054925   0.06  0.81024    
product2POS                0.295238  0.049233  35.96  2.0e-09 ***
antiplateletTRUE          -0.000745  0.079370   0.00  0.99252    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Estimated Scale Parameters:
            Estimate Std.err
(Intercept)    0.992  0.0248

Correlation: Structure = exchangeable  Link = identity 

Estimated Correlation Parameters:
      Estimate Std.err
alpha        0       0
Number of clusters:   29890   Maximum cluster size: 1 





## MCMCglmm ---------------------------

### Model7.3: same covariates as fit7.3.gee
```{r}
fm7.3.mcmc <- as.formula(paste("LMWH~", paste(vte_names_noref, collapse="+"), "+ age_s + n_comorb + time + race2 + male + education2 + vte_history + hospitalized + smoke + division2 + income_range + product2"))

# prior.12 <-list(R = list(V = diag(1), nu = 0.002), G = list(G1 = list(V = diag(3) * 0.02, nu = 4), G2 = list(V = 1, nu = 0.002)))

dat7.mcmc_nm <- c("patid",vte_names_noref,  "comorb01", "n_comorb","age_s", "time", "race2", "male", "education2", "vte_history", "hospitalized", "smoke", "division2","income_range", "product2", "LMWH")
dat7.mcmc <- na.omit(dat4[,..dat7.mcmc_nm])
dat7.mcmc$education <- factor(dat7.mcmc$education)

system.time(fit7.3.mcmc <- MCMCglmm(fm7.3.mcmc, random=~patid, data=dat7.mcmc, family="categorical", verbose=TRUE, burnin=10000, nitt = 60000, thin = 50))#, singular.ok = TRUE
#singular.ok  logical: if FALSE linear dependencies in the fixed effects are removed. if TRUE they are left in an estimated, although all information comes form the prior

summary(fit7.3.mcmc)
```
Acceptance ratio for liability set 1 = 0.439680

                       MCMC iteration = 53000

 Acceptance ratio for liability set 1 = 0.410104

                       MCMC iteration = 54000

 Acceptance ratio for liability set 1 = 0.405354

                       MCMC iteration = 55000

 Acceptance ratio for liability set 1 = 0.409163

                       MCMC iteration = 56000

 Acceptance ratio for liability set 1 = 0.349179

                       MCMC iteration = 57000

 Acceptance ratio for liability set 1 = 0.313271

                       MCMC iteration = 58000

 Acceptance ratio for liability set 1 = 0.323771

                       MCMC iteration = 59000

 Acceptance ratio for liability set 1 = 0.359087

                       MCMC iteration = 60000

 Acceptance ratio for liability set 1 = 0.328444
   user  system elapsed
2255.72  514.78 4478.55

 Iterations = 10001:59951
 Thinning interval  = 50
 Sample size  = 1000

 DIC: 18006.95

 G-structure:  ~patid

      post.mean l-95% CI u-95% CI eff.samp
patid     7.374    5.359    9.401    1.415

 R-structure:  ~units

      post.mean l-95% CI u-95% CI eff.samp
units  0.007391 0.001934  0.01722    5.281

 Location effects: LMWH ~ VTE_Lower.extremity.DVT + VTE_Other + VTE_Pulmonary.embolism + VTE_Upper.extremity.DVT + age_s + n_comorb + time + race2 + male + education2 + vte_history + hospitalized + smoke + division2 + income_range + product2

                           post.mean   l-95% CI   u-95% CI eff.samp  pMCMC
(Intercept)               -1.5280626 -1.8645386 -1.1645555   27.019 <0.001 ***
VTE_Lower.extremity.DVT   -0.3825554 -0.5338258 -0.2440470   18.982 <0.001 ***
VTE_Other                 -0.3395268 -0.5200930 -0.1809920   31.945 <0.001 ***
VTE_Pulmonary.embolism    -0.0275733 -0.2063152  0.1251811   17.285  0.762
VTE_Upper.extremity.DVT   -0.0211874 -0.2143854  0.2029877   22.768  0.782
age_s                     -0.5398630 -0.6408625 -0.4386055    6.483 <0.001 ***
n_comorb                  -0.0476709 -0.0717331 -0.0225915   76.909 <0.001 ***
timeac3mo_lmwh            -0.8148824 -0.9143202 -0.6750909    3.571 <0.001 ***
race2B                    -0.2975308 -0.5624199  0.0399526   28.109  0.060 .
race2U                    -0.4049738 -0.7242019  0.0274188   36.496  0.030 *
race2W                    -0.5069491 -0.8233675 -0.2022609    4.807 <0.001 ***
male                       0.0009415 -0.1104842  0.1170362   20.417  0.978
education2AB              -0.2693957 -0.4170456 -0.1223277   15.311 <0.001 ***
education2D                0.4116493  0.2405928  0.5671342   39.157 <0.001 ***
education2U               -0.0634913 -0.5500650  0.4579832   31.184  0.840
vte_history               -0.3436429 -0.6460267  0.0086305    1.216  0.054 .
hospitalizedTRUE           0.3824243  0.1803095  0.5459227    9.348 <0.001 ***
smokeTRUE                 -0.2584298 -1.6892554  0.7968735    6.889  0.758
division2EAST CENTRAL     -0.3044702 -0.4625437 -0.1420741   28.343 <0.001 ***
division2MOUNTAIN_PACIFIC -0.6031960 -0.8038369 -0.4318594   15.337 <0.001 ***
division2UNKNOWN          -0.6371916 -1.5549301  0.2729645   25.635  0.182
division2WEST CENTRAL     -0.3572666 -0.5275838 -0.2133891   26.026 <0.001 ***
income_range0             -0.2722616 -0.5580014  0.0015215    5.343  0.030 *
income_range1             -0.3678596 -0.5921705 -0.1452114   11.877 <0.001 ***
income_range2             -0.3323066 -0.5606086 -0.0761757   30.389  0.006 **
income_range3             -0.3456692 -0.5703658 -0.0950944   45.627  0.002 **
income_range4              0.0621106 -0.1915712  0.2864192   12.638  0.568
income_range5             -0.1697137 -0.3982619  0.0352526   10.307  0.156
product2HMO               -0.1537667 -0.3227043  0.0067204   30.620  0.056 .
product2OTH                0.1077513 -0.0648934  0.3004683   24.125  0.250
product2POS                0.5274457  0.3563896  0.6802646   55.815 <0.001 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

```{r}
png("a1_fit7.3.mcmc_trace_density.png", width = 1600, height = 10000)
par(mfrow=c(31,2), mar=c(1.5,1.5,1.5,1.5))
plot(fit7.3.mcmc$Sol, auto.layout=F) #, cex.main=1.25
title("MCMCglmm: LMWH ~ VTE_Lower.extremity.DVT + VTE_Other + \n VTE_Pulmonary.embolism + VTE_Upper.extremity.DVT + age_s + \n n_comorb + time + race2 + male + education2 + vte_history + \n hospitalized + smoke + division2 + income_range + product2",font=40, outer=TRUE)
dev.off()
```



### Model9: add antiplatelet based on model 7.3.mcmc

This same model was run twice and very different answers were yielded.
```{r}
fm9.mcmc <- as.formula(paste("LMWH~", paste(vte_names_noref, collapse="+"), "+ age_s + n_comorb + time + race2 + male + education2 + vte_history + hospitalized + smoke + division2 + income_range + product2 + antiplatelet"))

# prior.12 <-list(R = list(V = diag(1), nu = 0.002), G = list(G1 = list(V = diag(3) * 0.02, nu = 4), G2 = list(V = 1, nu = 0.002)))

dat9.mcmc_nm <- c("patid",vte_names_noref,  "comorb01", "n_comorb","age_s", "time", "race2", "male", "education2", "vte_history", "hospitalized", "smoke", "division2","income_range", "product2", "antiplatelet", "LMWH")
dat9.mcmc <- na.omit(dat4[,..dat9.mcmc_nm])

system.time(fit9.mcmc <- MCMCglmm(fm9.mcmc, random=~patid, data=dat9.mcmc, family="categorical", verbose=TRUE, burnin=10000, nitt = 60000, thin = 50))#, singular.ok = TRUE
#singular.ok  logical: if FALSE linear dependencies in the fixed effects are removed. if TRUE they are left in an estimated, although all information comes form the prior

summary(fit9.mcmc)
```

*First run:

 Acceptance ratio for liability set 1 = 0.412811

                       MCMC iteration = 53000

 Acceptance ratio for liability set 1 = 0.427589

                       MCMC iteration = 54000

 Acceptance ratio for liability set 1 = 0.359889

                       MCMC iteration = 55000

 Acceptance ratio for liability set 1 = 0.347461

                       MCMC iteration = 56000

 Acceptance ratio for liability set 1 = 0.318886

                       MCMC iteration = 57000

 Acceptance ratio for liability set 1 = 0.271246

                       MCMC iteration = 58000

 Acceptance ratio for liability set 1 = 0.252690

                       MCMC iteration = 59000

 Acceptance ratio for liability set 1 = 0.219151

                       MCMC iteration = 60000

 Acceptance ratio for liability set 1 = 0.201220
   user  system elapsed
2367.60  566.97 3010.14


 Iterations = 10001:59951
 Thinning interval  = 50
 Sample size  = 1000

 DIC: 17332.03

 G-structure:  ~patid

      post.mean l-95% CI u-95% CI eff.samp
patid     10.31    6.484    13.95    1.215

 R-structure:  ~units

      post.mean l-95% CI u-95% CI eff.samp
units   0.01956 0.003016  0.03672    5.388

 Location effects: LMWH ~ VTE_Lower.extremity.DVT + VTE_Other + VTE_Pulmonary.embolism + VTE_Upper.extremity.DVT + age_s + n_comorb + time + race2 + male + education2 + vte_history + hospitalized + smoke + division2 + income_range + product2 + antiplatelet

                          post.mean  l-95% CI  u-95% CI eff.samp  pMCMC
(Intercept)               -1.693033 -2.108257 -1.256714   20.828 <0.001 ***
VTE_Lower.extremity.DVT   -0.533418 -0.757219 -0.336283   14.288 <0.001 ***
VTE_Other                 -0.509395 -0.790540 -0.290552    8.294 <0.001 ***
VTE_Pulmonary.embolism    -0.085543 -0.258955  0.094183   53.826  0.356
VTE_Upper.extremity.DVT   -0.007297 -0.226752  0.231060   27.446  0.968
age_s                     -0.600997 -0.727246 -0.468625    6.669 <0.001 ***
n_comorb                  -0.049505 -0.090622 -0.015021   10.413 <0.001 ***
timeac3mo_lmwh            -0.979000 -1.192136 -0.774431    3.155 <0.001 ***
race2B                    -0.209637 -0.541118  0.084073   22.293  0.200
race2U                    -0.199972 -0.667311  0.271289   24.266  0.404
race2W                    -0.470103 -0.788994 -0.130234    4.181  0.008 **
male                       0.007589 -0.147964  0.151938   23.389  0.882
education2AB              -0.291649 -0.573469 -0.066446    4.236  0.006 **
education2D                0.413208  0.168612  0.625536   38.002 <0.001 ***
education2U               -0.144186 -0.682659  0.457481   31.930  0.622
vte_history               -0.502347 -0.783766 -0.233945   22.394 <0.001 ***
hospitalizedTRUE           0.451948  0.265724  0.636473   31.541 <0.001 ***
smokeTRUE                 -0.417654 -2.164456  0.898164   12.411  0.632
division2EAST CENTRAL     -0.352274 -0.556832 -0.151324   13.096 <0.001 ***
division2MOUNTAIN_PACIFIC -0.588605 -0.814441 -0.379136   23.018 <0.001 ***
division2UNKNOWN          -0.783951 -1.870146  0.290978   21.503  0.188
division2WEST CENTRAL     -0.434298 -0.635611 -0.239161   31.483 <0.001 ***
income_range0             -0.391193 -0.669554 -0.103064   23.800  0.006 **
income_range1             -0.485817 -0.769600 -0.217174   11.892 <0.001 ***
income_range2             -0.453391 -0.755309 -0.158175   39.543  0.004 **
income_range3             -0.409876 -0.835809 -0.041498    5.684  0.026 *
income_range4              0.074236 -0.208086  0.362947   31.161  0.538
income_range5             -0.254488 -0.544214  0.008117   18.910  0.058 .
product2HMO               -0.185036 -0.416027  0.035455   36.556  0.114
product2OTH                0.041304 -0.206228  0.300631   25.599  0.696
product2POS                0.603173  0.381950  0.810374   28.157 <0.001 ***
antiplateletTRUE          -0.029420 -0.378946  0.304293   36.374  0.850
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1


* Second run:
 Acceptance ratio for liability set 1 = 0.245853

                       MCMC iteration = 56000

 Acceptance ratio for liability set 1 = 0.257748

                       MCMC iteration = 57000

 Acceptance ratio for liability set 1 = 0.265468

                       MCMC iteration = 58000

 Acceptance ratio for liability set 1 = 0.289998

                       MCMC iteration = 59000

 Acceptance ratio for liability set 1 = 0.263022

                       MCMC iteration = 60000

 Acceptance ratio for liability set 1 = 0.224934
   user  system elapsed
2232.19  385.28 2792.97

 Iterations = 10001:59951
 Thinning interval  = 50
 Sample size  = 1000

 DIC: 18085.75

 G-structure:  ~patid

      post.mean l-95% CI u-95% CI eff.samp
patid     6.512    5.028    7.557    2.525

 R-structure:  ~units

      post.mean l-95% CI u-95% CI eff.samp
units   0.00493 0.002174  0.01156    7.079

 Location effects: LMWH ~ VTE_Lower.extremity.DVT + VTE_Other + VTE_Pulmonary.embolism + VTE_Upper.extremity.DVT + age_s + n_comorb + time + race2 + male + education2 + vte_history + hospitalized + smoke + division2 + income_range + product2 + antiplatelet

                          post.mean  l-95% CI  u-95% CI eff.samp  pMCMC
(Intercept)               -1.462096 -1.756647 -1.178204   52.237 <0.001 ***
VTE_Lower.extremity.DVT   -0.340742 -0.501059 -0.168969    4.941 <0.001 ***
VTE_Other                 -0.409279 -0.581536 -0.196915    7.328 <0.001 ***
VTE_Pulmonary.embolism     0.050037 -0.092858  0.200106   13.958  0.504
VTE_Upper.extremity.DVT    0.074087 -0.139253  0.316628    4.380  0.594
age_s                     -0.522083 -0.581200 -0.453055   47.673 <0.001 ***
n_comorb                  -0.043853 -0.078143 -0.014686    7.673  0.004 **
timeac3mo_lmwh            -0.780326 -0.865847 -0.692448    3.554 <0.001 ***
race2B                    -0.296520 -0.591999 -0.029765    7.798  0.060 .
race2U                    -0.278965 -0.656167  0.053843   24.107  0.108
race2W                    -0.445308 -0.655164 -0.190153    9.201 <0.001 ***
male                      -0.006795 -0.115961  0.095373   11.884  0.928
education2AB              -0.266133 -0.385376 -0.150664   93.482 <0.001 ***
education2D                0.327174  0.132389  0.510003    8.017 <0.001 ***
education2U               -0.097493 -0.649805  0.468670    3.187  0.710
vte_history               -0.537578 -0.734501 -0.348668   14.101 <0.001 ***
hospitalizedTRUE           0.402280  0.270387  0.523788   89.713 <0.001 ***
smokeTRUE                 -0.517169 -1.674558  0.374838   25.532  0.312
division2EAST CENTRAL     -0.263909 -0.452408 -0.097768    8.523 <0.001 ***
division2MOUNTAIN_PACIFIC -0.561521 -0.740648 -0.377991    5.485 <0.001 ***
division2UNKNOWN          -0.260904 -0.966242  0.555428   21.352  0.492
division2WEST CENTRAL     -0.288431 -0.442233 -0.152357   17.381 <0.001 ***
income_range0             -0.264044 -0.537470 -0.019277    8.268  0.030 *
income_range1             -0.409355 -0.578842 -0.231196   21.441 <0.001 ***
income_range2             -0.303659 -0.502876 -0.103476   55.289  0.002 **
income_range3             -0.395814 -0.634700 -0.191547   37.632 <0.001 ***
income_range4              0.019501 -0.168817  0.244878   16.665  0.860
income_range5             -0.142500 -0.344873  0.048894   11.994  0.166
product2HMO               -0.222417 -0.381343 -0.048308   17.793  0.004 **
product2OTH                0.075403 -0.094081  0.267763    8.632  0.472
product2POS                0.392196  0.218156  0.575282   12.370 <0.001 ***
antiplateletTRUE          -0.002253 -0.229364  0.263670   18.530  0.950
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

```{r}
png("a1_fit9.mcmc_trace_density2.png", width = 1800, height = 12000)
par(mfrow=c(32,2), mar=c(1.7,1.7,1.7,1.7))
plot(fit9.mcmc$Sol, auto.layout=F, cex=10, cex.lab=1.5, cex.axis=1.5,) #, cex.main=1.25
title("Second run \n MCMCglmm: LMWH ~ VTE_Lower.extremity.DVT + VTE_Other + \n VTE_Pulmonary.embolism + VTE_Upper.extremity.DVT + age_s + \n n_comorb + time + race2 + male + education2 + vte_history + \n hospitalized + smoke + division2 + income_range + product2 + antiplatelet", outer=TRUE)
dev.off()
```








-----------------------------------------------------------------------
# GLMM logistic for comparing proportions of Warfarin at indexAC versus AC3Mo

```{r}
dat5 <- melt(dat2, measure.vars = c("index_ac_warfarin", "ac3mo_warfarin"),
             value.name = "warfarin", variable.name = "time")
dat5[, c("clmid", "fill_dt", "category", "brand_name", "gen_name", "copay", "copay_sum", "days_sup", "quantity","strength", "npi", "index_ac_lmwh", "ac3mo_lmwh"):=NULL]
dat5 <- unique(dat5)

# sample_warfarin <- dat5[dat5$patid %in% sample_id,]
# sample_warfarin <- readRDS("test_sample_warfarin.rds")

# obtain variable names for index VTE types
# all distinct VTE categories
# vte_names0.w <- colnames(sample_warfarin)[grep("VTE_", colnames(sample_warfarin))]
# vte_names1.w <- vte_names0[-which(vte_names0.w %in% c("VTE_IVC","VTE_Portal.vein", "VTE_Renal.vein"))] 
# "VTE_ivc_rv_pv" as the reference level
# vte_names_noref.w <- vte_names1.w[-which(vte_names1.w == "VTE_ivc_rv_pv")]
```


### Model 1
```{r}
fm1.w <- as.formula(paste("warfarin~", paste(c(vte_names_noref), collapse="+"), "+ n_comorb + time + race2 + male+ age_s + product2 + income_range + education2 + hospitalized + vte_history + smoke + division2 + antiplatelet + (1 |patid)"))  # + comorb01 + education 
system.time(fit1.w <- glmer(fm1.w, data=dat5, family = "binomial", control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=1e8))))
summary(fit1.w)
```
   user  system elapsed
2833.70  462.76 3543.39

Generalized linear mixed model fit by maximum likelihood (Laplace
  Approximation) [glmerMod]
 Family: binomial  ( logit )
Formula:
warfarin ~ VTE_Lower.extremity.DVT + VTE_Other + VTE_Pulmonary.embolism +
    VTE_Upper.extremity.DVT + n_comorb + time + race2 + male +
    age_s + product2 + income_range + education2 + hospitalized +
    vte_history + smoke + division2 + antiplatelet + (1 | patid)
   Data: dat5
Control: glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e+08))

     AIC      BIC   logLik deviance df.resid
 35466.0  35740.1 -17700.0  35400.0    29857

Scaled residuals:
    Min      1Q  Median      3Q     Max
-1.8335 -0.4206  0.2274  0.3607  1.5221

Random effects:
 Groups Name        Variance Std.Dev.
 patid  (Intercept) 7.387    2.718
Number of obs: 29890, groups:  patid, 14945

Fixed effects:
                          Estimate Std. Error z value Pr(>|z|)
(Intercept)               -0.16084    0.18417  -0.873 0.382460
VTE_Lower.extremity.DVT    0.33786    0.07827   4.317 1.58e-05 ***
VTE_Other                  0.60316    0.09209   6.550 5.75e-11 ***
VTE_Pulmonary.embolism     0.04815    0.08282   0.581 0.560974
VTE_Upper.extremity.DVT    0.11255    0.10593   1.063 0.287991
n_comorb                   0.05181    0.01419   3.652 0.000260 ***
timeac3mo_warfarin        -0.80237    0.03575 -22.445  < 2e-16 ***
race2B                     0.17270    0.14343   1.204 0.228571
race2U                    -0.24561    0.20183  -1.217 0.223642
race2W                     0.35130    0.11903   2.951 0.003163 **
male                       0.06318    0.06182   1.022 0.306769
age_s                      0.35628    0.03966   8.983  < 2e-16 ***
product2HMO                0.42467    0.09776   4.344 1.40e-05 ***
product2OTH               -0.63772    0.10250  -6.221 4.93e-10 ***
product2POS               -0.57414    0.09882  -5.810 6.24e-09 ***
income_range0              0.69036    0.12438   5.550 2.85e-08 ***
income_range1              0.78828    0.10419   7.566 3.86e-14 ***
income_range2              0.53892    0.12871   4.187 2.82e-05 ***
income_range3              0.70751    0.13278   5.329 9.90e-08 ***
income_range4              0.23579    0.11972   1.969 0.048907 *
income_range5              0.37374    0.10940   3.416 0.000635 ***
education2AB               0.27949    0.07446   3.754 0.000174 ***
education2D               -0.31882    0.09684  -3.292 0.000994 ***
education2U                0.29539    0.25954   1.138 0.255053
hospitalizedTRUE           0.02346    0.08140   0.288 0.773149
vte_history                0.05495    0.10924   0.503 0.614944
smokeTRUE                 -0.20863    0.55752  -0.374 0.708253
division2EAST CENTRAL      0.41492    0.08566   4.844 1.28e-06 ***
division2MOUNTAIN_PACIFIC  0.59884    0.09106   6.576 4.83e-11 ***
division2UNKNOWN           1.34415    0.47733   2.816 0.004863 **
division2WEST CENTRAL      0.39805    0.08648   4.603 4.17e-06 ***
antiplateletTRUE          -0.07599    0.14373  -0.529 0.597026
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1



## Plot predicted probabilities:
```{r}
# individual coefficients including fixed and random effects
coef.ind.1w <- coef(fit1.w)$patid

# individual predicted probabilities
pred.ind.1w <- predict(fit1.w,type="response")

pdf("a1_predicted_prob_fit1.w.pdf")
hist(pred.ind.1w, breaks = 40, xlab="Predicted probability",
     main="warfarin ~ index_vte_type + comorbidities + n_comorb + time + \n race2 + male + age_s + product2 + income_range + education2 \n + hospitalized + vte_history + smoke + division2 + antiplatelet")
while (!is.null(dev.list()))  dev.off()

summary(pred.ind.1w)
```
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
0.02964 0.21326 0.68331 0.59483 0.91259 0.98812


### Model 2:
Same covariates as fm7.3.gee
```{r}
fm2.w.gee <- as.formula(paste("warfarin~", paste(vte_names_noref, collapse="+"), "+ age_s + n_comorb + time + race2 + male + education2 + vte_history + hospitalized + smoke + division2 + income_range + product2 + antiplatelet"))

fit2.w.gee <- geeglm(fm2.w.gee, family=binomial("logit"), id=patid, data = dat5, corstr="exchangeable")
summary(fit2.w.gee)
```





### Model 3
Use MCMCglmm. Same covariates as fit7.3.gee
```{r}
# dat3.w.mcmc_nm <- c("patid",vte_names_noref,  "comorb01", "n_comorb","age_s", "time", "race2", "male", "education2", "vte_history", "hospitalized", "smoke", "division2","income_range", "product2", "LMWH")
# dat7.mcmc <- na.omit(dat4[,..dat7.mcmc_nm])

fm2.w.mcmc <- as.formula(paste("warfarin~", paste(vte_names_noref, collapse="+"), "+ age_s + n_comorb + time + race2 + male + education2 + vte_history + hospitalized + smoke + division2 + income_range + product2"))

system.time(fit3.w.mcmc <- MCMCglmm(fm2.w.mcmc, random=~patid, data=dat5, family="categorical", verbose=TRUE, burnin=10000, nitt = 60000, thin = 50))#, singular.ok = TRUE
#singular.ok  logical: if FALSE linear dependencies in the fixed effects are removed. if TRUE they are left in an estimated, although all information comes form the prior

summary(fit3.w.mcmc)
```

 Acceptance ratio for liability set 1 = 0.661895

                       MCMC iteration = 56000

 Acceptance ratio for liability set 1 = 0.717415

                       MCMC iteration = 57000

 Acceptance ratio for liability set 1 = 0.738912

                       MCMC iteration = 58000

 Acceptance ratio for liability set 1 = 0.757214

                       MCMC iteration = 59000

 Acceptance ratio for liability set 1 = 0.779827

                       MCMC iteration = 60000

 Acceptance ratio for liability set 1 = 0.787201
   user  system elapsed
2290.11  487.43 2875.46

 Iterations = 10001:59951
 Thinning interval  = 50
 Sample size  = 1000

 DIC: 27337.86

 G-structure:  ~patid

      post.mean l-95% CI u-95% CI eff.samp
patid     10.58    8.713    11.78     2.77

 R-structure:  ~units

      post.mean l-95% CI u-95% CI eff.samp
units   0.03725  0.00848   0.1076    4.496

 Location effects: warfarin ~ VTE_Lower.extremity.DVT + VTE_Other + VTE_Pulmonary.embolism + VTE_Upper.extremity.DVT + age_s + n_comorb + time + race2 + male + education2 + vte_history + hospitalized + smoke + division2 + income_range + product2

                          post.mean l-95% CI u-95% CI eff.samp  pMCMC
(Intercept)                -0.25635 -0.65015  0.22547    36.47  0.268
VTE_Lower.extremity.DVT     0.34994  0.16883  0.52018    40.99 <0.001 ***
VTE_Other                   0.64960  0.43254  0.82501    82.69 <0.001 ***
VTE_Pulmonary.embolism      0.06972 -0.11478  0.23042    63.86  0.458
VTE_Upper.extremity.DVT     0.14292 -0.08041  0.36868    78.33  0.206
age_s                       0.35452  0.26740  0.44431    40.62 <0.001 ***
n_comorb                    0.05524  0.02316  0.08463    51.59 <0.001 ***
timeac3mo_warfarin         -0.89589 -0.99403 -0.80982    13.16 <0.001 ***
race2B                      0.22745 -0.10745  0.52590    44.58  0.146
race2U                     -0.19423 -0.56760  0.24524    93.59  0.350
race2W                      0.40296  0.13223  0.68701    53.98  0.004 **
male                        0.06327 -0.06054  0.19160   101.66  0.342
education2AB                0.28562  0.12597  0.43699    39.19 <0.001 ***
education2D                -0.29165 -0.50950 -0.07649    49.54  0.002 **
education2U                 0.37075 -0.17193  0.99890    56.78  0.198
vte_history                 0.08505 -0.14835  0.33641    65.69  0.514
hospitalizedTRUE            0.02103 -0.18801  0.18455    63.57  0.776
smokeTRUE                  -0.29898 -1.50480  0.84703    64.75  0.612
division2EAST CENTRAL       0.43328  0.23707  0.60206    32.14 <0.001 ***
division2MOUNTAIN_PACIFIC   0.64027  0.46599  0.84919    53.93 <0.001 ***
division2UNKNOWN            1.46944  0.45313  2.39074    69.54 <0.001 ***
division2WEST CENTRAL       0.42099  0.24340  0.61315    47.58 <0.001 ***
income_range0               0.69700  0.43546  0.97934    48.29 <0.001 ***
income_range1               0.83630  0.61048  1.08925    49.83 <0.001 ***
income_range2               0.54678  0.27067  0.79262    45.74 <0.001 ***
income_range3               0.71345  0.39969  1.01723    32.24 <0.001 ***
income_range4               0.25646  0.02174  0.54230    57.62  0.058 .
income_range5               0.39623  0.15264  0.63063    45.54 <0.001 ***
product2HMO                 0.43918  0.22806  0.65238    42.94 <0.001 ***
product2OTH                -0.62450 -0.83198 -0.38152    74.88 <0.001 ***
product2POS                -0.56001 -0.79416 -0.36693    53.29 <0.001 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1



Use glmer:
Running in Rstudio results in error:
```{r}
fm3.w <- as.formula(paste("warfarin~", paste(c(vte_names_noref), collapse="+"), "+ n_comorb + time + race + male+ age_s + product + income_range + (1 |patid)"))  # + networth_range  + comorb01 + education + 
system.time(fit3.w <- glmer(fm3.w, data=dat5, family = "binomial", control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=1e8))))
summary(fit3.w)
```
Error in qr.default(X, tol = tol, LAPACK = FALSE) : NA/NaN/Inf in foreign function call (arg 1)
Timing stopped at: 0.03 0.02 0.05


But no convergence issue in command line. (???)

   user  system elapsed
 143.78    3.53  156.79

Generalized linear mixed model fit by maximum likelihood (Laplace
  Approximation) [glmerMod]
 Family: binomial  ( logit )
Formula:
warfarin ~ VTE_Lower.extremity.DVT + VTE_Other + VTE_Pulmonary.embolism +
    VTE_Upper.extremity.DVT + n_comorb + time + race + male +
    age_s + product + income_range + occupation + (1 | patid)
   Data: sample_warfarin
Control: glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e+08))

     AIC      BIC   logLik deviance df.resid
  4638.2   4820.0  -2290.1   4580.2     3869

Scaled residuals:
    Min      1Q  Median      3Q     Max
-1.7616 -0.4103  0.2199  0.3538  1.4337

Random effects:
 Groups Name        Variance Std.Dev.
 patid  (Intercept) 7.5      2.739
Number of obs: 3898, groups:  patid, 1949

Fixed effects:
                        Estimate Std. Error z value Pr(>|z|)
(Intercept)              0.79579    0.60371   1.318 0.187449
VTE_Lower.extremity.DVT  0.21047    0.21266   0.990 0.322325
VTE_Other                0.38524    0.24810   1.553 0.120488
VTE_Pulmonary.embolism   0.05843    0.22541   0.259 0.795456
VTE_Upper.extremity.DVT  0.07442    0.29225   0.255 0.799007
n_comorb                 0.09627    0.03867   2.490 0.012789 *
timeac3mo_warfarin      -0.71968    0.09874  -7.289 3.12e-13 ***
raceA                   -1.05560    0.56866  -1.856 0.063414 .
raceB                   -0.03939    0.25547  -0.154 0.877471
raceH                    0.55765    0.38733   1.440 0.149948
raceU                   -1.08210    0.47410  -2.282 0.022465 *
male                    -0.16695    0.17290  -0.966 0.334264
age_s                    0.30072    0.11737   2.562 0.010401 *
productHMO               0.40726    0.40567   1.004 0.315421
productIND              -1.03105    0.56872  -1.813 0.069842 .
productOTH              -1.09651    0.42704  -2.568 0.010238 *
productPOS              -0.96338    0.38028  -2.533 0.011299 *
productPPO              -0.21255    0.48220  -0.441 0.659356
income_range0            1.33328    0.34717   3.840 0.000123 ***
income_range1            0.95790    0.26932   3.557 0.000376 ***
income_range2            0.83052    0.34539   2.405 0.016191 *
income_range3            1.15312    0.36129   3.192 0.001414 **
income_range4            0.79731    0.31767   2.510 0.012078 *
income_range5            0.57898    0.29289   1.977 0.048066 *
occupation2             -0.33282    0.54205  -0.614 0.539217
occupation3             -0.82382    0.60535  -1.361 0.173545
occupation4             -0.23474    0.48145  -0.488 0.625865
occupationU             -0.13419    0.40325  -0.333 0.739303
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation matrix not shown by default, as p = 28 > 12.
Use print(x, correlation=TRUE)  or
         vcov(x)         if you need it


```{r}
png("a1_fit3.w.mcmc_trace_density.png", width = 1600, height = 10000)
par(mfrow=c(31,2), mar=c(1.5,1.5,1.5,1.5))
plot(fit3.w.mcmc$Sol, auto.layout=F) #, cex.main=1.25
title("MCMCglmm: LMWH ~ VTE_Lower.extremity.DVT + VTE_Other + \n VTE_Pulmonary.embolism + VTE_Upper.extremity.DVT + \n n_comorb + time + race + male + age_s + product + \n income_range + occupation",font=40, outer=TRUE)
dev.off()
```



### Model 4:
```{r}
fm4.w <- as.formula(paste("warfarin~", paste(c(vte_names_noref.w), collapse="+"), "+ n_comorb + time + race + male+ age_s + product + income_range + networth_range  + (1 |patid)"))  #   + comorb01 + education + 
system.time(fit4.w <- glmer(fm4.w, data=test_sample_warfarin, family = "binomial", control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=1e8))))
summary(fit4.w)
```
Command line output:

   user  system elapsed
 708.25   12.18  752.38

Generalized linear mixed model fit by maximum likelihood (Laplace
  Approximation) [glmerMod]
 Family: binomial  ( logit )
Formula:
warfarin ~ VTE_Lower.extremity.DVT + VTE_Other + VTE_Pulmonary.embolism +
    VTE_Upper.extremity.DVT + n_comorb + time + race + male +
    age_s + product + income_range + home_ownership + networth_range +
    occupation + (1 | patid)
   Data: sample_warfarin
Control: glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e+08))

     AIC      BIC   logLik deviance df.resid
  4643.4   4862.8  -2286.7   4573.4     3863

Scaled residuals:
    Min      1Q  Median      3Q     Max
-1.7220 -0.4111  0.2166  0.3547  1.4532

Random effects:
 Groups Name        Variance Std.Dev.
 patid  (Intercept) 7.5      2.739
Number of obs: 3898, groups:  patid, 1949

Fixed effects:
                        Estimate Std. Error z value Pr(>|z|)
(Intercept)              1.26883    1.08605   1.168  0.24268
VTE_Lower.extremity.DVT  0.19185    0.21344   0.899  0.36874
VTE_Other                0.37550    0.24829   1.512  0.13044
VTE_Pulmonary.embolism   0.04790    0.22569   0.212  0.83192
VTE_Upper.extremity.DVT  0.05739    0.29281   0.196  0.84463
n_comorb                 0.09808    0.03886   2.524  0.01161 *
timeac3mo_warfarin      -0.72081    0.09883  -7.294 3.02e-13 ***
raceA                   -1.00666    0.56898  -1.769  0.07686 .
raceB                   -0.01015    0.25966  -0.039  0.96880
raceH                    0.57698    0.38900   1.483  0.13801
raceU                   -1.04156    0.47442  -2.195  0.02813 *
male                    -0.16500    0.17308  -0.953  0.34044
age_s                    0.31882    0.12274   2.597  0.00939 **
productHMO               0.45794    0.40667   1.126  0.26014
productIND              -0.97815    0.56944  -1.718  0.08584 .
productOTH              -1.04386    0.42790  -2.440  0.01471 *
productPOS              -0.91839    0.38069  -2.412  0.01585 *
productPPO              -0.17513    0.48353  -0.362  0.71721
income_range0            0.90221    0.85125   1.060  0.28921
income_range1            0.79617    0.31811   2.503  0.01232 *
income_range2            0.69495    0.36849   1.886  0.05931 .
income_range3            1.01295    0.37930   2.671  0.00757 **
income_range4            0.67325    0.33025   2.039  0.04149 *
income_range5            0.51485    0.29829   1.726  0.08435 .
home_ownership          -0.43882    0.31909  -1.375  0.16906
networth_range1         -0.24912    0.93926  -0.265  0.79084
networth_range2         -0.14944    0.91361  -0.164  0.87007
networth_range3          0.35165    0.93028   0.378  0.70543
networth_range4          0.13528    0.92951   0.146  0.88428
networth_range5         -0.20019    0.93594  -0.214  0.83063
occupation2             -0.36683    0.54326  -0.675  0.49953
occupation3             -0.86738    0.60735  -1.428  0.15325
occupation4             -0.27631    0.48315  -0.572  0.56740
occupationU             -0.17564    0.40466  -0.434  0.66427
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation matrix not shown by default, as p = 34 > 12.
Use print(x, correlation=TRUE)  or
         vcov(x)         if you need it


## Plot predicted probabilities:
```{r}
# individual coefficients including fixed and random effects
coef.ind.4w <- coef(fit4.w)$patid

# individual predicted probabilities
pred.ind.4w <- predict(fit4.w,type="response")

pdf("a1_predicted_prob_fit4.w.pdf")
hist(pred.ind.4w, breaks = 40, xlab="Predicted probability",
     main="warfarin ~ index_vte_type + comorbidities + time + \n race + male + age_s + income_range + education")
while (!is.null(dev.list()))  dev.off()

summary(pred.ind)
```


```{r}
fm4.w <- as.formula(paste("warfarin~", paste(c(vte_names_noref.w), collapse="+"), "+ n_comorb + time + race + male+ age_s + product + income_range + networth_range  + (1 |patid)"))  #   + comorb01 + education + 
system.time(fit4.w <- glmer(fm4.w, data=test_sample_warfarin, family = "binomial", control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=1e8))))
summary(fit4.w)
```